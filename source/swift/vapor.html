<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Swift Vapor学习 | Jovins Blog</title>
    <meta name="description" content="Work Hard, Play Hard">
    <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.fa6af71c.css" as="style"><link rel="preload" href="/assets/js/app.f2e3cb52.js" as="script"><link rel="preload" href="/assets/js/101.2e004423.js" as="script"><link rel="prefetch" href="/assets/js/10.99bbcf46.js"><link rel="prefetch" href="/assets/js/100.8d269315.js"><link rel="prefetch" href="/assets/js/102.dd5a6d67.js"><link rel="prefetch" href="/assets/js/103.0930fc18.js"><link rel="prefetch" href="/assets/js/11.6995aa03.js"><link rel="prefetch" href="/assets/js/12.d1aeb970.js"><link rel="prefetch" href="/assets/js/13.3808cbb9.js"><link rel="prefetch" href="/assets/js/14.05c65f0c.js"><link rel="prefetch" href="/assets/js/15.8210a4e7.js"><link rel="prefetch" href="/assets/js/16.dd637c2e.js"><link rel="prefetch" href="/assets/js/17.1bac9075.js"><link rel="prefetch" href="/assets/js/18.a60404ed.js"><link rel="prefetch" href="/assets/js/19.5029f548.js"><link rel="prefetch" href="/assets/js/2.3b324bd1.js"><link rel="prefetch" href="/assets/js/20.71aeb006.js"><link rel="prefetch" href="/assets/js/21.49d3534c.js"><link rel="prefetch" href="/assets/js/22.28c254f2.js"><link rel="prefetch" href="/assets/js/23.55c74fb4.js"><link rel="prefetch" href="/assets/js/24.ce688c11.js"><link rel="prefetch" href="/assets/js/25.92ac2101.js"><link rel="prefetch" href="/assets/js/26.d144c623.js"><link rel="prefetch" href="/assets/js/27.dbc07e6f.js"><link rel="prefetch" href="/assets/js/28.72e03149.js"><link rel="prefetch" href="/assets/js/29.9f1f46fe.js"><link rel="prefetch" href="/assets/js/3.8e2386c4.js"><link rel="prefetch" href="/assets/js/30.ecfcb095.js"><link rel="prefetch" href="/assets/js/31.e00708c5.js"><link rel="prefetch" href="/assets/js/32.e66cde85.js"><link rel="prefetch" href="/assets/js/33.17b34f1f.js"><link rel="prefetch" href="/assets/js/34.ba2e8263.js"><link rel="prefetch" href="/assets/js/35.a35b2bf9.js"><link rel="prefetch" href="/assets/js/36.0f8ee978.js"><link rel="prefetch" href="/assets/js/37.9631b873.js"><link rel="prefetch" href="/assets/js/38.83917b50.js"><link rel="prefetch" href="/assets/js/39.5eb3b0f7.js"><link rel="prefetch" href="/assets/js/4.8c89249f.js"><link rel="prefetch" href="/assets/js/40.6577bc48.js"><link rel="prefetch" href="/assets/js/41.03d32368.js"><link rel="prefetch" href="/assets/js/42.285f334f.js"><link rel="prefetch" href="/assets/js/43.0dbac324.js"><link rel="prefetch" href="/assets/js/44.516aa197.js"><link rel="prefetch" href="/assets/js/45.f8b2e75e.js"><link rel="prefetch" href="/assets/js/46.57e9fe18.js"><link rel="prefetch" href="/assets/js/47.b165fdb0.js"><link rel="prefetch" href="/assets/js/48.aa65e477.js"><link rel="prefetch" href="/assets/js/49.ef99c175.js"><link rel="prefetch" href="/assets/js/5.20de59e0.js"><link rel="prefetch" href="/assets/js/50.dbeb44bd.js"><link rel="prefetch" href="/assets/js/51.5e2171f9.js"><link rel="prefetch" href="/assets/js/52.7634b21e.js"><link rel="prefetch" href="/assets/js/53.7bd0a528.js"><link rel="prefetch" href="/assets/js/54.01408fa6.js"><link rel="prefetch" href="/assets/js/55.e5207e84.js"><link rel="prefetch" href="/assets/js/56.58dc7dc8.js"><link rel="prefetch" href="/assets/js/57.807d5ae4.js"><link rel="prefetch" href="/assets/js/58.c4c79d2d.js"><link rel="prefetch" href="/assets/js/59.6642f800.js"><link rel="prefetch" href="/assets/js/6.b9dd5642.js"><link rel="prefetch" href="/assets/js/60.6b7b9dd4.js"><link rel="prefetch" href="/assets/js/61.5aeeb802.js"><link rel="prefetch" href="/assets/js/62.9cdb5886.js"><link rel="prefetch" href="/assets/js/63.afdbcf9a.js"><link rel="prefetch" href="/assets/js/64.4feec3f4.js"><link rel="prefetch" href="/assets/js/65.01ba651f.js"><link rel="prefetch" href="/assets/js/66.056b66d4.js"><link rel="prefetch" href="/assets/js/67.c2c8c5bf.js"><link rel="prefetch" href="/assets/js/68.6b9a7204.js"><link rel="prefetch" href="/assets/js/69.a20a5f13.js"><link rel="prefetch" href="/assets/js/7.919dc9ca.js"><link rel="prefetch" href="/assets/js/70.1931c188.js"><link rel="prefetch" href="/assets/js/71.57fb23ee.js"><link rel="prefetch" href="/assets/js/72.8372585b.js"><link rel="prefetch" href="/assets/js/73.090b450b.js"><link rel="prefetch" href="/assets/js/74.1f2a6bf8.js"><link rel="prefetch" href="/assets/js/75.4fd94b1a.js"><link rel="prefetch" href="/assets/js/76.b8670ce9.js"><link rel="prefetch" href="/assets/js/77.071bdc59.js"><link rel="prefetch" href="/assets/js/78.befd2888.js"><link rel="prefetch" href="/assets/js/79.ae9bdbfb.js"><link rel="prefetch" href="/assets/js/8.5bd05e3a.js"><link rel="prefetch" href="/assets/js/80.efecfca0.js"><link rel="prefetch" href="/assets/js/81.58171b2c.js"><link rel="prefetch" href="/assets/js/82.0308dcb2.js"><link rel="prefetch" href="/assets/js/83.d0b23df5.js"><link rel="prefetch" href="/assets/js/84.70b15320.js"><link rel="prefetch" href="/assets/js/85.b0f15c7e.js"><link rel="prefetch" href="/assets/js/86.842cbc20.js"><link rel="prefetch" href="/assets/js/87.78626080.js"><link rel="prefetch" href="/assets/js/88.74b57552.js"><link rel="prefetch" href="/assets/js/89.d6bbb9ba.js"><link rel="prefetch" href="/assets/js/9.4a615f07.js"><link rel="prefetch" href="/assets/js/90.e3526e1d.js"><link rel="prefetch" href="/assets/js/91.56e0a0b6.js"><link rel="prefetch" href="/assets/js/92.ecf957b4.js"><link rel="prefetch" href="/assets/js/93.5e7580df.js"><link rel="prefetch" href="/assets/js/94.a311b382.js"><link rel="prefetch" href="/assets/js/95.efcff5d2.js"><link rel="prefetch" href="/assets/js/96.0b29e685.js"><link rel="prefetch" href="/assets/js/97.52744029.js"><link rel="prefetch" href="/assets/js/98.2b890125.js"><link rel="prefetch" href="/assets/js/99.85ff620d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fa6af71c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jovins Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/source/swift/" class="nav-link router-link-active">Swift</a></div><div class="nav-item"><a href="/source/go/" class="nav-link">Go</a></div><div class="nav-item"><a href="/source/program/" class="nav-link">小程序</a></div><div class="nav-item"><a href="/source/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/source/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="https://github.com/Jovins" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/source/swift/" class="nav-link router-link-active">Swift</a></div><div class="nav-item"><a href="/source/go/" class="nav-link">Go</a></div><div class="nav-item"><a href="/source/program/" class="nav-link">小程序</a></div><div class="nav-item"><a href="/source/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/source/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="https://github.com/Jovins" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>技术文章</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Swift 文章</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/source/swift/" class="sidebar-link">Swift可选类型Optional的用法</a></li><li><a href="/source/swift/RxSwift-5.0.html" class="sidebar-link">RxSwift 5.0 内容更新</a></li><li><a href="/source/swift/Swift-ABI.html" class="sidebar-link">Swift ABI 稳定后的几个问题</a></li><li><a href="/source/swift/Swift-5-original-String.html" class="sidebar-link">Swift 5 中使用原始字符串</a></li><li><a href="/source/swift/swift5-newfuture.html" class="sidebar-link">Swift 5 新特性</a></li><li><a href="/source/swift/Swift-String-Substring.html" class="sidebar-link">Swift中String和Substring</a></li><li><a href="/source/swift/Swift-defer.html" class="sidebar-link">Swift defer 的正确使用</a></li><li><a href="/source/swift/result-types.html" class="sidebar-link">泛型Opaque Result Types</a></li><li><a href="/source/swift/xcode10-2.html" class="sidebar-link">Xcode 10.2</a></li><li><a href="/source/swift/vapor.html" class="active sidebar-link">Swift Vapor学习</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#mvc-——-m" class="sidebar-link">MVC —— M</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#mvc-——-c" class="sidebar-link">MVC —— C</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#更新-orm" class="sidebar-link">更新 ORM</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#修改-config-swift" class="sidebar-link">修改 config.swift</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#运行" class="sidebar-link">运行</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#增加一个字段" class="sidebar-link">增加一个字段</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#删除一个字段" class="sidebar-link">删除一个字段</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#auth" class="sidebar-link">Auth</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#注册" class="sidebar-link">注册</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#basic-authorization" class="sidebar-link">Basic Authorization</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#bearer-authorization" class="sidebar-link">Bearer Authorization</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#创建-token-model" class="sidebar-link">创建 Token Model</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#添加配置" class="sidebar-link">添加配置</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#修改-user-model" class="sidebar-link">修改 User Model</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#路由方法" class="sidebar-link">路由方法</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#修改-config-swift-2" class="sidebar-link">修改 config.swift</a></li><li class="sidebar-sub-header"><a href="/source/swift/vapor.html#后记" class="sidebar-link">后记</a></li></ul></li><li><a href="/source/swift/Swift-4-Codable.html" class="sidebar-link">Swift 4 Codable 协议</a></li><li><a href="/source/swift/Swift-Tuple-inout.html" class="sidebar-link">元组Tuple和其关键字inout</a></li><li><a href="/source/swift/Swift-Protocol.html" class="sidebar-link">Swift 协议 protocol</a></li><li><a href="/source/swift/Swift-Moya-design.html" class="sidebar-link">Moya框架设计浅谈</a></li><li><a href="/source/swift/Swift-Error.html" class="sidebar-link">Swift Error 的分类</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>OpenGL/OpenGL ES</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="swift-vapor学习"><a href="#swift-vapor学习" aria-hidden="true" class="header-anchor">#</a> Swift Vapor学习</h1> <h2 id="前言"><a href="#前言" aria-hidden="true" class="header-anchor">#</a> 前言</h2> <p>为什么选择 <code>Vapor</code>？</p> <ul><li>在 <code>2018 @Swift</code> 大会上虾神对 <code>Swift Serve Side</code> 做了一个 lightning talk，对 <code>Vapor</code> 十分赞扬；</li> <li>陆陆续续看了网上的一些资料，发现大家对 <code>Vapor</code> 关注度也更高一些；</li> <li><code>Vapor</code> 在语法和相关 <code>API</code> 的设计上会更加 <code>Swifty</code> 一些；</li> <li>github 上的所有 <code>Swift Sever Side</code> 框架中它的 <code>star</code> 是最多。</li></ul> <p><a href="https://github.com/vapor" target="_blank" rel="noopener noreferrer">下载vapor<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://link.juejin.im?target=https%3A%2F%2Fdocs.vapor.codes%2F3.0%2Finstall%2Fmacos%2F" target="_blank" rel="noopener noreferrer">详见官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h5 id="运行-hello-world"><a href="#运行-hello-world" aria-hidden="true" class="header-anchor">#</a> 运行 <code>Hello, world!</code></h5> <ul><li><code>vapor new yourProjectName</code>。创建模版工程，当然可以加上 <code>--template=api</code> 来创建提供对应服务的模版工程，但我测试了一下好像跟其它模版工程没什么区别。</li> <li><code>vapor xcode</code>。创建 Xcode 工程，特别特别慢，而且会有一定几率失败。（估计是学校的网太破</li></ul> <h2 id="mvc-——-m"><a href="#mvc-——-m" aria-hidden="true" class="header-anchor">#</a> MVC —— M</h2> <p><code>Vapor</code> 默认是 <code>SQLite</code> 的<strong>内存</strong>数据库。我原本想看看 <code>Vapor</code> 自带的 <code>SQLite</code> 数据库中的表，但没翻着，最后想了一下，这是内存数据库啊，也就是说，每次 <code>Run</code> 数据都会被清空。可以从 <code>config.swift</code> 中看出：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// ...</span>
<span class="token keyword">let</span> sqlite <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token function">SQLiteDatabase</span><span class="token punctuation">(</span>storage<span class="token punctuation">:</span> <span class="token punctuation">.</span>memory<span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><p>在 <code>Vapor</code> 文档中写了推荐使用 <code>Fluent</code> ORM 框架进行数据库表结构的管理，刚开始我并不了解关于 <code>Fluent</code> 的任何内容，可以查看模版文件中的 <code>Todo.swift</code>：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">FluentSQLite</span>
<span class="token keyword">import</span> <span class="token builtin">Vapor</span>


<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Todo</span><span class="token punctuation">:</span> <span class="token builtin">SQLiteModel</span> <span class="token punctuation">{</span>
    <span class="token comment">/// 唯一标识符</span>
    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span>
    <span class="token keyword">var</span> title<span class="token punctuation">:</span> <span class="token builtin">String</span>

    <span class="token keyword">init</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token constant">nil</span><span class="token punctuation">,</span> title<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
        <span class="token keyword">self</span><span class="token punctuation">.</span>title <span class="token operator">=</span> title
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 实现数据库操作。如增加表字段，更新表结构</span>
<span class="token keyword">extension</span> <span class="token builtin">Todo</span><span class="token punctuation">:</span> <span class="token builtin">Migration</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">/// 允许从 HTTP 消息中编解码出对应数据</span>
<span class="token keyword">extension</span> <span class="token builtin">Todo</span><span class="token punctuation">:</span> <span class="token builtin">Content</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">/// 允许使用动态的使用在路由中定义的参数</span>
<span class="token keyword">extension</span> <span class="token builtin">Todo</span><span class="token punctuation">:</span> <span class="token builtin">Parameter</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><p>从模版文件中的 <code>Model</code> 可以看出来创建一张表结构相当于是<strong>描述一个类</strong>，之前有使用过 <code>Django</code> 的经验，看到 <code>Vapor</code> 的这种 ORM 这么 <code>Swift</code> 确实眼前一亮。<code>Vapor</code> 同样可以遵循 <code>MVC</code> 设计模式进行构建，在生成的模版文件中也确实是基于 <code>MVC</code> 去做的。</p> <h2 id="mvc-——-c"><a href="#mvc-——-c" aria-hidden="true" class="header-anchor">#</a> MVC —— C</h2> <p>如果我们只使用 <code>Vapor</code> 做 <code>API</code> 服务，可以不用管 <code>V</code> 层，在 <code>Vapor</code> 的“视图”部分，使用的 <code>Leaf</code> 库做的渲染，具体细节因为没学习过不做展开。</p> <p>而对于 <code>C</code> 来说，整体的思路跟以往写 App 时的思路大致相当，在 <code>C</code> 层中处理好数据和视图的关系，只不过此处只需要处理数据和数据之间的关系就好了。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">Vapor</span>

<span class="token comment">/// Controls basic CRUD operations on `Todo`s.</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TodoController</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Returns a list of all `Todo`s.</span>
    <span class="token keyword">func</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token builtin">Todo</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token builtin">Todo</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Saves a decoded `Todo` to the database.</span>
    <span class="token keyword">func</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">Todo</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token builtin">Todo</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> todo <span class="token keyword">in</span>
            <span class="token keyword">return</span> todo<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Deletes a parameterized `Todo`.</span>
    <span class="token keyword">func</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">HTTPStatus</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token builtin">Todo</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> todo <span class="token keyword">in</span>
            <span class="token keyword">return</span> todo<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token punctuation">.</span>ok<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从以上模版文件中生成的 <code>TodoController</code> 可以看出，大量结合了 <code>Future</code> 异步特性，初次接触会有点懵，有同学推荐结合 <code>PromiseKit</code> 其实会更香。</p> <p>##<code>Package.swift</code></p> <p>在 <code>Package.swift</code> 中写下对应库依赖，</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">PackageDescription</span>

<span class="token keyword">let</span> package <span class="token operator">=</span> <span class="token function">Package</span><span class="token punctuation">(</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Unicorn-Server&quot;</span><span class="token punctuation">,</span>
    products<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">library</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Unicorn-Server&quot;</span><span class="token punctuation">,</span> targets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/vapor/vapor.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// here</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/vapor/fluent-mysql.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    targets<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;App&quot;</span><span class="token punctuation">,</span>
                dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token string">&quot;Vapor&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;FluentMySQL&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Run&quot;</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">testTarget</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;AppTests&quot;</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><p>触发更新</p> <div class="language- extra-class"><pre class="language-text"><code>vapor xcode
</code></pre></div><p><code>Vapor</code> 搞了我几次，更新依赖的时候特别慢，而且还更新失败，导致我现在每次更新时都要去确认一遍依赖是否更新成功。</p> <h2 id="更新-orm"><a href="#更新-orm" aria-hidden="true" class="header-anchor">#</a> 更新 ORM</h2> <p>更新成功后，我们就可以根据之前生成的模版文件 <code>Todo.swift</code> 的样式改成 <code>MySQL</code> 版本的 ORM：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">FluentMySQL</span>
<span class="token keyword">import</span> <span class="token builtin">Vapor</span>

<span class="token comment">/// A simple user.</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span> <span class="token builtin">MySQLModel</span> <span class="token punctuation">{</span>
    <span class="token comment">/// The unique identifier for this user.</span>
    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span>
    
    <span class="token comment">/// The user's full name.</span>
    <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token builtin">String</span>
    
    <span class="token comment">/// The user's current age in years.</span>
    <span class="token keyword">var</span> age<span class="token punctuation">:</span> <span class="token builtin">Int</span>
    
    <span class="token comment">/// Creates a new user.</span>
    <span class="token keyword">init</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token constant">nil</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
        <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name
        <span class="token keyword">self</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Allows `User` to be used as a dynamic migration.</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Migration</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">/// Allows `User` to be encoded to and decoded from HTTP messages.</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Content</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">/// Allows `User` to be used as a dynamic parameter in route definitions.</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Parameter</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
</code></pre></div><p>以上是我新建的 User Model，换成 Todo Model 也是一样的。改动的地方只有两个，<code>import FluentMySQL</code> 和继承自 <code>MySQLModel</code>。这点还算不错，通过 <code>Fluent</code> 抹平了各种数据库的使用，不管你底层是什么数据库，都只需要导入然后切换继承即可。</p> <h2 id="修改-config-swift"><a href="#修改-config-swift" aria-hidden="true" class="header-anchor">#</a> 修改 <code>config.swift</code></h2> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">FluentMySQL</span>
<span class="token keyword">import</span> <span class="token builtin">Vapor</span>

<span class="token comment">/// 应用初始化完会被调用</span>
<span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token number">_</span> config<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Config</span><span class="token punctuation">,</span> <span class="token number">_</span> env<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Environment</span><span class="token punctuation">,</span> <span class="token number">_</span> services<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Services</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
    <span class="token comment">// === mysql ===</span>
    <span class="token comment">// 首先注册数据库</span>
    <span class="token keyword">try</span> services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token function">FluentMySQLProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册路由到路由器中进行管理</span>
    <span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token builtin">EngineRouter</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token function">routes</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>
    services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>router<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token builtin">Router</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册中间件</span>
    <span class="token comment">// 创建一个中间件配置文件</span>
    <span class="token keyword">var</span> middlewares <span class="token operator">=</span> <span class="token function">MiddlewareConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 错误中间件。捕获错误并转化到 HTTP 返回体中</span>
    middlewares<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token builtin">ErrorMiddleware</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span>
    services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>middlewares<span class="token punctuation">)</span>
    
    <span class="token comment">// === mysql ===</span>
    <span class="token comment">// 配置 MySQL 数据库</span>
    <span class="token keyword">let</span> mysql <span class="token operator">=</span> <span class="token function">MySQLDatabase</span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token function">MySQLDatabaseConfig</span><span class="token punctuation">(</span>hostname<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> port<span class="token punctuation">:</span> <span class="token number">3306</span><span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> database<span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> capabilities<span class="token punctuation">:</span> <span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">,</span> characterSet<span class="token punctuation">:</span> <span class="token punctuation">.</span>utf8mb4_unicode_ci<span class="token punctuation">,</span> transport<span class="token punctuation">:</span> <span class="token punctuation">.</span>unverifiedTLS<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">// 注册 SQLite 数据库配置文件到数据库配置中心</span>
    <span class="token keyword">var</span> databases <span class="token operator">=</span> <span class="token function">DatabasesConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// === mysql ===</span>
    databases<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>database<span class="token punctuation">:</span> mysql<span class="token punctuation">,</span> <span class="token keyword">as</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>mysql<span class="token punctuation">)</span>
    services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>databases<span class="token punctuation">)</span>

    <span class="token comment">// 配置迁移文件。相当于注册表</span>
    <span class="token keyword">var</span> migrations <span class="token operator">=</span> <span class="token function">MigrationConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// === mysql ===</span>
    migrations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>model<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> database<span class="token punctuation">:</span> <span class="token punctuation">.</span>mysql<span class="token punctuation">)</span>
    services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>migrations<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意 <code>MySQLDatabaseConfig</code> 的配置信息。如果我们的 <code>MySQL</code> 版本在 <strong>8</strong> 以上，目前只能选择 <code>unverifiedTLS</code> 进行验证连接MySQL容器时使用的安全连接选项，也即 <code>transport</code> 字段。在代码中用 <code>// === mysql ===</code> 进行标记的代码块是跟模版文件中使用 <code>SQLite</code> 所不同的地方。</p> <h2 id="运行"><a href="#运行" aria-hidden="true" class="header-anchor">#</a> 运行</h2> <p>运行工程，进入 <code>MySQL</code> 进行查看。</p> <div class="language-mysql extra-class"><pre class="language-text"><code>mysql&gt; show tables;
+----------------------+
| Tables_in_unicorn_db |
+----------------------+
| fluent               |
| Sticker              |
| User                 |
+----------------------+
3 rows in set (0.01 sec)

mysql&gt; desc User;
+-------+--------------+------+-----+---------+----------------+
| Field | Type         | Null | Key | Default | Extra          |
+-------+--------------+------+-----+---------+----------------+
| id    | bigint(20)   | NO   | PRI | NULL    | auto_increment |
| name  | varchar(255) | NO   |     | NULL    |                |
| age   | bigint(20)   | NO   |     | NULL    |                |
+-------+--------------+------+-----+---------+----------------+
3 rows in set (0.01 sec)
</code></pre></div><p><code>Vapor</code> 不像 <code>Django</code> 那般在生成的表加上前缀，而是你 ORM 类名是什么，最终生成的表名就是什么，这点很喜欢！</p> <h2 id="增加一个字段"><a href="#增加一个字段" aria-hidden="true" class="header-anchor">#</a> 增加一个字段</h2> <p><code>Vapor</code> 同样也没有像 <code>Django</code> 那么强大的工作流，很多人都说 <code>Perfect</code> 像 <code>Django</code>，我自己的认为 <code>Vapor</code> 像 <code>Flask</code>。</p> <p>对 <code>Vapor</code> 修改表字段，不仅仅只是修改 <code>Model</code> 属性这么简单，同样也不像 <code>Django</code> 中修改完后，执行 <code>python manage.py makemigrations</code> 和 <code>python manage.py migrate</code> 就结束了，我们需要自己创建迁移文件，自己写清楚此次表结构到底发生了什么改变。</p> <p>在泊学的<a href="https://link.juejin.im?target=https%3A%2F%2Fboxueio.com%2Fseries%2Fvapor-fluent%2Febook%2F473" target="_blank" rel="noopener noreferrer">这篇文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中推荐在 <code>App</code> 目录下创建一个 <code>Migrations group</code>，方便操作。但我思考了一下，这么做势必会造成 <code>Model</code> 和对应的迁移文件割裂，然后在另外一个上级文件夹中又要对不同迁移文件所属的 <code>Model</code> 做切分，这很显然是有一些问题的。最后，我脑子冒出了一个非常可怕的想法：“<code>Django</code> 是一个非常强大、架构非常良好的框架！”。</p> <p>最后我的目录是这样的：</p> <div class="language- extra-class"><pre class="language-text"><code>Models
└── User
    ├── Migrations
    │   ├── 19-04-30-AddUserCreatedTime.swift
    │   └── 19-04-30-DeleteUserNickname.swift
    ├── UserController.swift
    └── User.swift
</code></pre></div><p>这是 <code>Django</code> 中的一个 <code>app</code> 文件树：</p> <div class="language- extra-class"><pre class="language-text"><code>user_avatar
├── __init__.py
├── admin.py
├── apps.py
├── migrations
│   ├── 0001_initial.py
│   ├── 0002_auto_20190303_2154.py
│   ├── 0002_auto_20190303_2209.py
│   ├── 0003_auto_20190303_2154.py
│   ├── 0003_auto_20190322_1638.py
│   ├── 0004_merge_20190408_2131.py
│   └── __init__.py
├── models.py
├── tests.py
├── urls.py
└── views.py
</code></pre></div><p>已经删除掉了一些非重要信息。可以看到，<code>Django</code> 的 <code>app</code> 文件夹结构非常好！注意看 <code>migrations</code> 文件夹下的迁移文件命名。如果开发能力不错的话，我们是可以做到与业务无关的 <code>app</code> 发布供他人直接导入到工程中。</p> <p>不过关于工程文件的管理，这是一个智者见智的事情啦～对于我个人来说，我反而更加喜欢 <code>Vapor</code>/<code>Flask</code> 一系，因为需要什么再加什么，整个设计模式也可以按照自己的喜好来做。</p> <p>给 <code>User</code> Model 添加一个 <code>createdTime</code> 字段。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">FluentMySQL</span>

<span class="token keyword">struct</span> <span class="token builtin">AddUserCreatedTime</span><span class="token punctuation">:</span> <span class="token builtin">MySQLMigration</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function">prepare</span><span class="token punctuation">(</span>on conn<span class="token punctuation">:</span> <span class="token builtin">MySQLConnection</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">EventLoopFuture</span><span class="token operator">&lt;</span><span class="token builtin">Void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token builtin">MySQLDatabase</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> on<span class="token punctuation">:</span> conn<span class="token punctuation">,</span> closure<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            $<span class="token number">0</span><span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> \<span class="token builtin">User</span><span class="token punctuation">.</span>fluentCreatedAt<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function">revert</span><span class="token punctuation">(</span>on conn<span class="token punctuation">:</span> <span class="token builtin">MySQLConnection</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">EventLoopFuture</span><span class="token operator">&lt;</span><span class="token builtin">Void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 直接返回</span>
        <span class="token keyword">return</span> conn<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="删除一个字段"><a href="#删除一个字段" aria-hidden="true" class="header-anchor">#</a> 删除一个字段</h2> <p>使用 <code>Swift</code> 开发服务端很容易受到使用 <code>Swift</code> 做其它开发的影响。刚开始时我确实认为在 <code>Model</code> 中把需要删除的字段删除就好了，然而运行工程后去查数据库发现并不是这么一回事。</p> <p>首先，我们需要先创建一个文件来写 <code>Model</code> 的迁移代码，但这不是必须的，你可以把该 <code>Model</code> 后续需要进行表字段的 CURD 都写在同一个文件中，因为每一个迁移都是一个 <code>struct</code>。我的做法是像上文所说，对每一个迁移都做新文件，并且每一个迁移文件都写上“时间”和“做了什么”。</p> <p>在 <code>prepare</code> 方法中调用 <code>DatabaseKit</code> 的 <code>create</code> 方法，<code>Fluent</code> 支持大部分数据库，且都基于 <code>DatabaseKit</code> 对支持的这些大部分数据库做了二次封装。</p> <p>通过 <code>Fluent</code> 对表删除一个字段，需要在<strong>增加表字段时就要做好</strong>，否则需要重新写一个迁移文件，例如，我们可以把上文代码中的 <code>revert</code> 方法改为：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function">revert</span><span class="token punctuation">(</span>on conn<span class="token punctuation">:</span> <span class="token builtin">MySQLConnection</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">EventLoopFuture</span><span class="token operator">&lt;</span><span class="token builtin">Void</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token builtin">MySQLDatabase</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> on<span class="token punctuation">:</span> conn<span class="token punctuation">,</span> closure<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        $<span class="token number">0</span><span class="token punctuation">.</span><span class="token function">deleteField</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> \<span class="token builtin">User</span><span class="token punctuation">.</span>fluentCreatedAt<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果此时我们直接运行工程，是不会有任何效果的，因为直接运行工程并不会触发 <code>revert</code> 方法，我们需要激活 <code>Vapor</code> 两个命令，在 <code>config.swift</code> 中：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">var</span> commands <span class="token operator">=</span> <span class="token builtin">CommandConfig</span><span class="token punctuation">.</span><span class="token keyword">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
commands<span class="token punctuation">.</span><span class="token function">useFluentCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>commands<span class="token punctuation">)</span>
</code></pre></div><p>接着，在终端中输入：<code>vapor build &amp;&amp; vapor run revert</code> 即可撤销上一次新增的字段。使用 <code>vapor build &amp;&amp; vapor run revert -all</code> 可以撤销全部生成的表。</p> <p>问题来了！当我的 <code>revert</code> 方法中写明当撤销迁移时，把表进行删除，一切正常。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">return</span> <span class="token builtin">MySQLDatabase</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> on<span class="token punctuation">:</span> conn<span class="token punctuation">)</span>
</code></pre></div><p>但如果我要执行当撤销迁移时，把表中 <code>fluentCreatedAt</code> 字段删除时，失败！！！搞了 N 久也没有成功，几乎翻遍了网上所有内容，也没法解决，几乎都是这么写然后执行撤回迁移命令就生效了。后边再看吧。</p> <h4 id="修改一个表字段"><a href="#修改一个表字段" aria-hidden="true" class="header-anchor">#</a> 修改一个表字段</h4> <p>暂留。</p> <h2 id="auth"><a href="#auth" aria-hidden="true" class="header-anchor">#</a> Auth</h2> <p>在 <code>Vapor</code> 中有两种对用户鉴权的方式。一为适用 <code>API</code> 服务的 <code>Stateless</code> 方式，二为适用于 <code>Web</code> 的 <code>Sessions</code>，</p> <p>添加依赖</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// swift-tools-version:4.0</span>
<span class="token keyword">import</span> <span class="token builtin">PackageDescription</span>

<span class="token keyword">let</span> package <span class="token operator">=</span> <span class="token function">Package</span><span class="token punctuation">(</span>
    name<span class="token punctuation">:</span> <span class="token string">&quot;Unicorn-Server&quot;</span><span class="token punctuation">,</span>
    products<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">library</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Unicorn-Server&quot;</span><span class="token punctuation">,</span> targets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/vapor/vapor.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/SwiftyJSON/SwiftyJSON.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;4.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/vapor/fluent-mysql.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;3.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// 添加 auth</span>
        <span class="token punctuation">.</span><span class="token function">package</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token string">&quot;https://github.com/vapor/auth.git&quot;</span><span class="token punctuation">,</span> from<span class="token punctuation">:</span> <span class="token string">&quot;2.0.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    targets<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;App&quot;</span><span class="token punctuation">,</span>
                dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                    <span class="token string">&quot;Vapor&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;SwiftyJSON&quot;</span><span class="token punctuation">,</span>
                    <span class="token string">&quot;FluentMySQL&quot;</span><span class="token punctuation">,</span>
                    <span class="token comment">// 添加 auth</span>
                    <span class="token string">&quot;Authentication&quot;</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">target</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Run&quot;</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token function">testTarget</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string">&quot;AppTests&quot;</span><span class="token punctuation">,</span> dependencies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;App&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre></div><p>执行 <code>vapor xcode</code> 拉取依赖并重新生成 <code>Xcode</code> 工程。</p> <h2 id="注册"><a href="#注册" aria-hidden="true" class="header-anchor">#</a> 注册</h2> <p>在 <code>config.swift</code> 中增加：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token number">_</span> config<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Config</span><span class="token punctuation">,</span> <span class="token number">_</span> env<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Environment</span><span class="token punctuation">,</span> <span class="token number">_</span> services<span class="token punctuation">:</span> <span class="token keyword">inout</span> <span class="token builtin">Services</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">try</span> services<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token function">AuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="basic-authorization"><a href="#basic-authorization" aria-hidden="true" class="header-anchor">#</a> Basic Authorization</h2> <p>简单来说，该方式就是验证密码。我们需要维护一个做 <code>Basic Authorization</code> 方式进行鉴权的 <code>Path</code> 集合。请求属于该集合中的 <code>Path</code> 时，都需要把用户名和密码用 <code>:</code> 进行连接成新的字符串，且做 <code>base64</code> 加密，例如，<code>username</code> 为 <code>pjhubs</code>，<code>password</code> 为 <code>pjhubs123</code>，则，拼接后的结果为 <code>pjhubs:pjhubs123</code>，加密完的结果为 <code>cGpodWJzOnBqaHViczEyMw==</code>。按照如下格式添加到每次发起 <code>HTTP</code> 请求的 <code>header</code> 中：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">Authorization</span><span class="token punctuation">:</span> <span class="token builtin">Basic</span> cGpodWJzOnBqaHViczEyMw<span class="token operator">==</span>
</code></pre></div><h2 id="bearer-authorization"><a href="#bearer-authorization" aria-hidden="true" class="header-anchor">#</a> Bearer Authorization</h2> <p>当用户登录成功后，我们应该返回一个完整的 <code>token</code> 用于标识该用户已经在我们系统中登录且验证成功，并让该 <code>token</code> 和用户进行关联。使用 <code>Bearer Authorization</code> 方式进行权限验证，我们需要自行生成 <code>token</code>，可以使用任何方法进行生成，<code>Vapor</code> 官方并没有提供对应的生成工具，只要能够保持全局唯一即可。每次进行 <code>HTTP</code> 请求时，把 <code>token</code> 按照如下格式直接添加到 <code>HTTP request</code> 中，假设此次请求的 <code>token</code> 为 <code>pxoGJUtBVn7MXWoajWH+iw==</code>，则完整的 <code>HTTP header</code> 为：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">Authorization</span><span class="token punctuation">:</span> <span class="token builtin">Bearer</span> pxoGJUtBVn7MXWoajWH<span class="token operator">+</span>iw<span class="token operator">==</span>
</code></pre></div><h2 id="创建-token-model"><a href="#创建-token-model" aria-hidden="true" class="header-anchor">#</a> 创建 <code>Token</code> Model</h2> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">Foundation</span>
<span class="token keyword">import</span> <span class="token builtin">Vapor</span>
<span class="token keyword">import</span> <span class="token builtin">FluentMySQL</span>
<span class="token keyword">import</span> <span class="token builtin">Authentication</span>


<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Token</span><span class="token punctuation">:</span> <span class="token builtin">MySQLModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span>
    <span class="token keyword">var</span> userId<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token constant">ID</span>
    <span class="token keyword">var</span> token<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> fluentCreatedAt<span class="token punctuation">:</span> <span class="token builtin">Date</span><span class="token operator">?</span>
    
    <span class="token keyword">init</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> userId<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>token <span class="token operator">=</span> token
        <span class="token keyword">self</span><span class="token punctuation">.</span>userId <span class="token operator">=</span> userId
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">Token</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> user<span class="token punctuation">:</span> <span class="token builtin">Parent</span><span class="token operator">&lt;</span><span class="token builtin">Token</span><span class="token punctuation">,</span> <span class="token builtin">User</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">parent</span><span class="token punctuation">(</span>\<span class="token punctuation">.</span>userId<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实现 `BearerAuthenticatable` 协议，并返回绑定的 `tokenKey` 以告知使用 `Token` Model 的哪个属性作为真正的 `token`</span>
<span class="token keyword">extension</span> <span class="token builtin">Token</span><span class="token punctuation">:</span> <span class="token builtin">BearerAuthenticatable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">var</span> tokenKey<span class="token punctuation">:</span> <span class="token builtin">WritableKeyPath</span><span class="token operator">&lt;</span><span class="token builtin">Token</span><span class="token punctuation">,</span> <span class="token builtin">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> \<span class="token builtin">Token</span><span class="token punctuation">.</span>token <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">Token</span><span class="token punctuation">:</span> <span class="token builtin">Migration</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">extension</span> <span class="token builtin">Token</span><span class="token punctuation">:</span> <span class="token builtin">Content</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">extension</span> <span class="token builtin">Token</span><span class="token punctuation">:</span> <span class="token builtin">Parameter</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// 实现 `Authentication.Token` 协议，使 `Token` 成为 `Authentication.Token`</span>
<span class="token keyword">extension</span> <span class="token builtin">Token</span><span class="token punctuation">:</span> <span class="token builtin">Authentication</span><span class="token punctuation">.</span><span class="token builtin">Token</span> <span class="token punctuation">{</span>
    <span class="token comment">// 指定协议中的 `UserType` 为自定义的 `User`</span>
    <span class="token keyword">typealias</span> <span class="token builtin">UserType</span> <span class="token operator">=</span> <span class="token builtin">User</span>
    <span class="token comment">// 置顶协议中的 `UserIDType` 为自定义的 `User.ID`</span>
    <span class="token keyword">typealias</span> <span class="token builtin">UserIDType</span> <span class="token operator">=</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token constant">ID</span>
    
    <span class="token comment">// `token` 与 `user` 进行绑定</span>
    <span class="token keyword">static</span> <span class="token keyword">var</span> userIDKey<span class="token punctuation">:</span> <span class="token builtin">WritableKeyPath</span><span class="token operator">&lt;</span><span class="token builtin">Token</span><span class="token punctuation">,</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token constant">ID</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> \<span class="token builtin">Token</span><span class="token punctuation">.</span>userId
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">Token</span> <span class="token punctuation">{</span>
    <span class="token comment">/// `token` 生成</span>
    <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">for</span> user<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Token</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> random <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token function">CryptoRandom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateData</span><span class="token punctuation">(</span><span class="token builtin">count</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token function">Token</span><span class="token punctuation">(</span>token<span class="token punctuation">:</span> random<span class="token punctuation">.</span><span class="token function">base64EncodedString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userId<span class="token punctuation">:</span> user<span class="token punctuation">.</span><span class="token function">requireID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="添加配置"><a href="#添加配置" aria-hidden="true" class="header-anchor">#</a> 添加配置</h2> <p>在 <code>config.swift</code> 中写下 <code>Token</code> 的配置信息。</p> <div class="language-swift extra-class"><pre class="language-swift"><code>migrations<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>model<span class="token punctuation">:</span> <span class="token builtin">Token</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> database<span class="token punctuation">:</span> <span class="token punctuation">.</span>mysql<span class="token punctuation">)</span>
</code></pre></div><h2 id="修改-user-model"><a href="#修改-user-model" aria-hidden="true" class="header-anchor">#</a> 修改 <code>User</code> Model</h2> <p>让 <code>User</code> 和 <code>Token</code> 进行关联。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">Vapor</span>
<span class="token keyword">import</span> <span class="token builtin">FluentMySQL</span>
<span class="token keyword">import</span> <span class="token builtin">Authentication</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span> <span class="token builtin">MySQLModel</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span>
    <span class="token keyword">var</span> phoneNumber<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> nickname<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token keyword">var</span> password<span class="token punctuation">:</span> <span class="token builtin">String</span>
    
    <span class="token keyword">init</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token constant">nil</span><span class="token punctuation">,</span>
         phoneNumber<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>
         password<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span>
         nickname<span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id
        <span class="token keyword">self</span><span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname
        <span class="token keyword">self</span><span class="token punctuation">.</span>password <span class="token operator">=</span> password
        <span class="token keyword">self</span><span class="token punctuation">.</span>phoneNumber <span class="token operator">=</span> phoneNumber
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Migration</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Content</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">Parameter</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token comment">// 实现 `TokenAuthenticatable`。当 `User` 中的方法需要进行 `token` 验证时，需要关联哪个 Model</span>
<span class="token keyword">extension</span> <span class="token builtin">User</span><span class="token punctuation">:</span> <span class="token builtin">TokenAuthenticatable</span> <span class="token punctuation">{</span>
    <span class="token keyword">typealias</span> <span class="token builtin">TokenType</span> <span class="token operator">=</span> <span class="token builtin">Token</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token function">Public</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>id<span class="token operator">!</span><span class="token punctuation">,</span> nickname<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>nickname<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">User</span> <span class="token punctuation">{</span>
    <span class="token comment">/// User 对外输出信息，因为并不想把整个 `User` 实体的所有属性都暴露出去</span>
    <span class="token keyword">struct</span> <span class="token builtin">Public</span><span class="token punctuation">:</span> <span class="token builtin">Content</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> id<span class="token punctuation">:</span> <span class="token builtin">Int</span>
        <span class="token keyword">let</span> nickname<span class="token punctuation">:</span> <span class="token builtin">String</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">extension</span> <span class="token builtin">Future</span> <span class="token keyword">where</span> T<span class="token punctuation">:</span> <span class="token builtin">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">func</span> <span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">map</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token keyword">in</span>
            <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="路由方法"><a href="#路由方法" aria-hidden="true" class="header-anchor">#</a> 路由方法</h2> <p>使用 <code>Basic Authorization</code> 方式做用户鉴权后，我们就可以把需要使用鉴权的方法和非鉴权的方法按照如下方式在 <code>UserController.swift</code> 文件分开进行路由，如果这个文件你没有，需要新建一个。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">Vapor</span>
<span class="token keyword">import</span> <span class="token builtin">Authentication</span>

<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span><span class="token punctuation">:</span> <span class="token builtin">RouteCollection</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 重载 `boot` 方法，在控制器中定义路由</span>
    <span class="token keyword">func</span> <span class="token function">boot</span><span class="token punctuation">(</span>router<span class="token punctuation">:</span> <span class="token builtin">Router</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> userRouter <span class="token operator">=</span> router<span class="token punctuation">.</span><span class="token function">grouped</span><span class="token punctuation">(</span><span class="token string">&quot;api&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
        
        <span class="token comment">// 正常路由</span>
        <span class="token keyword">let</span> userController <span class="token operator">=</span> <span class="token function">UserController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;register&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>register<span class="token punctuation">)</span>
        router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;login&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>login<span class="token punctuation">)</span>
        
        <span class="token comment">// `tokenAuthMiddleware` 该中间件能够自行寻找当前 `HTTP header` 的 `Authorization` 字段中的值，并取出与该 `token` 对应的 `user`，并把结果缓存到请求缓存中供后续其它方法使用</span>
        <span class="token comment">// 需要进行 `token` 鉴权的路由</span>
        <span class="token keyword">let</span> tokenAuthenticationMiddleware <span class="token operator">=</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token function">tokenAuthMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> authedRoutes <span class="token operator">=</span> userRouter<span class="token punctuation">.</span><span class="token function">grouped</span><span class="token punctuation">(</span>tokenAuthenticationMiddleware<span class="token punctuation">)</span>
        authedRoutes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;profile&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>profile<span class="token punctuation">)</span>
        authedRoutes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;logout&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>logout<span class="token punctuation">)</span>
        authedRoutes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
        authedRoutes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;delete&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>delete<span class="token punctuation">)</span>
        authedRoutes<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> use<span class="token punctuation">:</span> userController<span class="token punctuation">.</span>update<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">func</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">HTTPResponse</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span><span class="token function">requireAuthenticated</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token builtin">Token</span>
            <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>\<span class="token builtin">Token</span><span class="token punctuation">.</span>userId<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token builtin">equal</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">requireID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token function">HTTPResponse</span><span class="token punctuation">(</span>status<span class="token punctuation">:</span> <span class="token punctuation">.</span>ok<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">profile</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span><span class="token function">requireAuthenticated</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> req<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">all</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> $<span class="token number">0</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">HTTPStatus</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> req<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flatMap <span class="token punctuation">{</span> todo <span class="token keyword">in</span>
            <span class="token keyword">return</span> todo<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token punctuation">.</span>ok<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">func</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token number">_</span> req<span class="token punctuation">:</span> <span class="token builtin">Request</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Future</span><span class="token operator">&lt;</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token function">flatMap</span><span class="token punctuation">(</span>to<span class="token punctuation">:</span> <span class="token builtin">User</span><span class="token punctuation">.</span><span class="token builtin">Public</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span><span class="token builtin">User</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span>user<span class="token punctuation">,</span> updatedUser<span class="token punctuation">)</span> <span class="token keyword">in</span>
            user<span class="token punctuation">.</span>nickname <span class="token operator">=</span> updatedUser<span class="token punctuation">.</span>nickname
            user<span class="token punctuation">.</span>password <span class="token operator">=</span> updatedUser<span class="token punctuation">.</span>password
            <span class="token keyword">return</span> user<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>on<span class="token punctuation">:</span> req<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要注意的是，如果某个路由方法需要从 <code>token</code> 关联的用户取信息才需要 <code>let user = try req.requireAuthenticated(User.self)</code> 这行代码取用户，否则如果我们仅仅只是需要对某个路由方法进行鉴权，只需要加入到 <code>tokenAuthenticationMiddleware</code> 的路由组中即可。</p> <p>并且， 我们不需要传入当前登录用户有关的任何信息，仅仅只需要一个 <code>token</code> 即可。</p> <h2 id="修改-config-swift-2"><a href="#修改-config-swift-2" aria-hidden="true" class="header-anchor">#</a> 修改 <code>config.swift</code></h2> <p>最后，把我们实现了 <code>RouteCollection</code> 协议的 <code>userController</code> 加入到 <code>config.swift</code> 中进行路由注册即可。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">import</span> <span class="token builtin">Vapor</span>

<span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token number">_</span> router<span class="token punctuation">:</span> <span class="token builtin">Router</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户路由</span>
    <span class="token keyword">let</span> usersController <span class="token operator">=</span> <span class="token function">UserController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span> router<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> usersController<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="后记"><a href="#后记" aria-hidden="true" class="header-anchor">#</a> 后记</h2> <p>感觉当一些设计模式的 tips 杂糅在一起后，就特别像 <code>Django</code>。但是和 <code>Django</code> 又有很大的不同，在一些细节上 <code>Vapor</code> 处理的不够好，看得云里雾里的，文档不够简单明了，或许，老外都这样？</p> <p>在这次的学习当中，心中冒出了很多次“为什么我要用这个破东西？”，但每次冒出这个想法时，最后都忍住了，因为这可是 <code>Swift</code> 啊！</p> <p>作者：PJHubs</p> <p>链接：https://juejin.im/post/5ccc7d3fe51d453afc760317</p> <p>来源：掘金</p> <p>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/source/swift/xcode10-2.html" class="prev">
          Xcode 10.2
        </a></span> <span class="next"><a href="/source/swift/Swift-4-Codable.html">
          Swift 4 Codable 协议
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.f2e3cb52.js" defer></script><script src="/assets/js/101.2e004423.js" defer></script>
  </body>
</html>
