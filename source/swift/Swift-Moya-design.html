<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Moya框架设计浅谈 | Jovins Blog</title>
    <meta name="description" content="Work Hard, Play Hard">
    <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/assets/css/0.styles.fa6af71c.css" as="style"><link rel="preload" href="/assets/js/app.1622ce37.js" as="script"><link rel="preload" href="/assets/js/84.9867ac89.js" as="script"><link rel="prefetch" href="/assets/js/10.e8a91e17.js"><link rel="prefetch" href="/assets/js/11.34ac8c24.js"><link rel="prefetch" href="/assets/js/12.93e30075.js"><link rel="prefetch" href="/assets/js/13.f44b8b5d.js"><link rel="prefetch" href="/assets/js/14.9214b855.js"><link rel="prefetch" href="/assets/js/15.71f3a960.js"><link rel="prefetch" href="/assets/js/16.88a87101.js"><link rel="prefetch" href="/assets/js/17.f55fa6ad.js"><link rel="prefetch" href="/assets/js/18.c4ce4fa8.js"><link rel="prefetch" href="/assets/js/19.dae2299f.js"><link rel="prefetch" href="/assets/js/2.4443a441.js"><link rel="prefetch" href="/assets/js/20.9d9e883d.js"><link rel="prefetch" href="/assets/js/21.fc58b11b.js"><link rel="prefetch" href="/assets/js/22.c9017d18.js"><link rel="prefetch" href="/assets/js/23.1704ebac.js"><link rel="prefetch" href="/assets/js/24.4956bf2b.js"><link rel="prefetch" href="/assets/js/25.a1a586b7.js"><link rel="prefetch" href="/assets/js/26.202c90df.js"><link rel="prefetch" href="/assets/js/27.eb074a2f.js"><link rel="prefetch" href="/assets/js/28.9147d291.js"><link rel="prefetch" href="/assets/js/29.2ce5ce5a.js"><link rel="prefetch" href="/assets/js/3.18065a48.js"><link rel="prefetch" href="/assets/js/30.6ce4ea57.js"><link rel="prefetch" href="/assets/js/31.bef24390.js"><link rel="prefetch" href="/assets/js/32.42be1210.js"><link rel="prefetch" href="/assets/js/33.8c8ba2ae.js"><link rel="prefetch" href="/assets/js/34.d13eda88.js"><link rel="prefetch" href="/assets/js/35.a889d196.js"><link rel="prefetch" href="/assets/js/36.dc8b7868.js"><link rel="prefetch" href="/assets/js/37.55ac6ead.js"><link rel="prefetch" href="/assets/js/38.8e62c7e8.js"><link rel="prefetch" href="/assets/js/39.ffb44221.js"><link rel="prefetch" href="/assets/js/4.4b2bc4a3.js"><link rel="prefetch" href="/assets/js/40.08f9e068.js"><link rel="prefetch" href="/assets/js/41.b629d5a9.js"><link rel="prefetch" href="/assets/js/42.3230ab3f.js"><link rel="prefetch" href="/assets/js/43.ebc48f08.js"><link rel="prefetch" href="/assets/js/44.88cd2852.js"><link rel="prefetch" href="/assets/js/45.465f4680.js"><link rel="prefetch" href="/assets/js/46.cdd16daf.js"><link rel="prefetch" href="/assets/js/47.b9e92111.js"><link rel="prefetch" href="/assets/js/48.224c4a3e.js"><link rel="prefetch" href="/assets/js/49.0d6541d5.js"><link rel="prefetch" href="/assets/js/5.d428b30f.js"><link rel="prefetch" href="/assets/js/50.02b5804c.js"><link rel="prefetch" href="/assets/js/51.eb5adb6a.js"><link rel="prefetch" href="/assets/js/52.993af258.js"><link rel="prefetch" href="/assets/js/53.3023f07f.js"><link rel="prefetch" href="/assets/js/54.b5cf3ff6.js"><link rel="prefetch" href="/assets/js/55.c7338642.js"><link rel="prefetch" href="/assets/js/56.04432a4c.js"><link rel="prefetch" href="/assets/js/57.291247c4.js"><link rel="prefetch" href="/assets/js/58.2bc4f03d.js"><link rel="prefetch" href="/assets/js/59.e2c85249.js"><link rel="prefetch" href="/assets/js/6.a698cd7f.js"><link rel="prefetch" href="/assets/js/60.7b7373bc.js"><link rel="prefetch" href="/assets/js/61.270729a3.js"><link rel="prefetch" href="/assets/js/62.aff157f7.js"><link rel="prefetch" href="/assets/js/63.61cb7d04.js"><link rel="prefetch" href="/assets/js/64.daa8bacb.js"><link rel="prefetch" href="/assets/js/65.d5f13487.js"><link rel="prefetch" href="/assets/js/66.a9b37a08.js"><link rel="prefetch" href="/assets/js/67.fd915ea0.js"><link rel="prefetch" href="/assets/js/68.2b3a6803.js"><link rel="prefetch" href="/assets/js/69.881b744a.js"><link rel="prefetch" href="/assets/js/7.cda84f21.js"><link rel="prefetch" href="/assets/js/70.33a19190.js"><link rel="prefetch" href="/assets/js/71.a0fb6053.js"><link rel="prefetch" href="/assets/js/72.2093995b.js"><link rel="prefetch" href="/assets/js/73.5b89728a.js"><link rel="prefetch" href="/assets/js/74.98e1725e.js"><link rel="prefetch" href="/assets/js/75.db1ee158.js"><link rel="prefetch" href="/assets/js/76.b77e39ea.js"><link rel="prefetch" href="/assets/js/77.7564f16a.js"><link rel="prefetch" href="/assets/js/78.fe0e304b.js"><link rel="prefetch" href="/assets/js/79.250d5274.js"><link rel="prefetch" href="/assets/js/8.eb1b4227.js"><link rel="prefetch" href="/assets/js/80.47265f20.js"><link rel="prefetch" href="/assets/js/81.14b3b38a.js"><link rel="prefetch" href="/assets/js/82.edcd54e3.js"><link rel="prefetch" href="/assets/js/83.a3fe7ee7.js"><link rel="prefetch" href="/assets/js/85.b0a5ea0c.js"><link rel="prefetch" href="/assets/js/86.7f67750f.js"><link rel="prefetch" href="/assets/js/87.11a9c4fd.js"><link rel="prefetch" href="/assets/js/88.ab829dff.js"><link rel="prefetch" href="/assets/js/89.f39a134b.js"><link rel="prefetch" href="/assets/js/9.a676dd68.js"><link rel="prefetch" href="/assets/js/90.61ad4afd.js"><link rel="prefetch" href="/assets/js/91.007f14e4.js"><link rel="prefetch" href="/assets/js/92.d1a65c6f.js"><link rel="prefetch" href="/assets/js/93.16c5e57d.js"><link rel="prefetch" href="/assets/js/94.4143ce67.js"><link rel="prefetch" href="/assets/js/95.9f7a8670.js"><link rel="prefetch" href="/assets/js/96.a2c49eb9.js"><link rel="prefetch" href="/assets/js/97.14d87c46.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fa6af71c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Jovins Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/source/swift/" class="nav-link router-link-active">Swift</a></div><div class="nav-item"><a href="/source/go/" class="nav-link">Go</a></div><div class="nav-item"><a href="/source/program/" class="nav-link">小程序</a></div><div class="nav-item"><a href="/source/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/source/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="https://github.com/Jovins" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/source/swift/" class="nav-link router-link-active">Swift</a></div><div class="nav-item"><a href="/source/go/" class="nav-link">Go</a></div><div class="nav-item"><a href="/source/program/" class="nav-link">小程序</a></div><div class="nav-item"><a href="/source/algorithm/" class="nav-link">算法</a></div><div class="nav-item"><a href="/source/git/" class="nav-link">Git</a></div><div class="nav-item"><a href="https://github.com/Jovins" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>技术文章</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Swift 文章</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/source/swift/" class="sidebar-link">Swift可选类型Optional的用法</a></li><li><a href="/source/swift/RxSwift-5.0.html" class="sidebar-link">RxSwift 5.0 内容更新</a></li><li><a href="/source/swift/Swift-ABI.html" class="sidebar-link">Swift ABI 稳定后的几个问题</a></li><li><a href="/source/swift/Swift-5-original-String.html" class="sidebar-link">Swift 5 中使用原始字符串</a></li><li><a href="/source/swift/swift5-newfuture.html" class="sidebar-link">Swift 5 新特性</a></li><li><a href="/source/swift/Swift-String-Substring.html" class="sidebar-link">Swift中String和Substring</a></li><li><a href="/source/swift/Swift-defer.html" class="sidebar-link">Swift defer 的正确使用</a></li><li><a href="/source/swift/result-types.html" class="sidebar-link">泛型Opaque Result Types</a></li><li><a href="/source/swift/xcode10-2.html" class="sidebar-link">Xcode 10.2</a></li><li><a href="/source/swift/vapor.html" class="sidebar-link">Swift Vapor学习</a></li><li><a href="/source/swift/Swift-4-Codable.html" class="sidebar-link">Swift 4 Codable 协议</a></li><li><a href="/source/swift/Swift-Tuple-inout.html" class="sidebar-link">元组Tuple和其关键字inout</a></li><li><a href="/source/swift/Swift-Protocol.html" class="sidebar-link">Swift 协议 protocol</a></li><li><a href="/source/swift/Swift-Moya-design.html" class="active sidebar-link">Moya框架设计浅谈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#关于moya" class="sidebar-link">关于Moya</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#面向协议编程（pop）" class="sidebar-link">面向协议编程（POP）</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#moya的模块组成" class="sidebar-link">Moya的模块组成</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#provider" class="sidebar-link">Provider</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#request" class="sidebar-link">Request</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#provider发送请求" class="sidebar-link">Provider发送请求</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#response" class="sidebar-link">Response</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#plugins" class="sidebar-link">Plugins</a></li><li class="sidebar-sub-header"><a href="/source/swift/Swift-Moya-design.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/source/swift/Swift-Error.html" class="sidebar-link">Swift Error 的分类</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>OpenGL/OpenGL ES</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="moya框架设计浅谈"><a href="#moya框架设计浅谈" aria-hidden="true" class="header-anchor">#</a> Moya框架设计浅谈</h1> <h2 id="关于moya"><a href="#关于moya" aria-hidden="true" class="header-anchor">#</a> 关于Moya</h2> <p>Moya是一个网络抽象层，它在底层将Alamofire进行封装，对外提供更简洁的接口供开发者调用。在以往的Objective-C中，大部分开发者会使用AFNetwork进行网络请求，当业务复杂一些时，会对AFNetwork进行二次封装，编写一个适用于自己项目的网络抽象层。在Objective-C中，有著名的<a href="https://github.com/yuantiku/YTKNetwork" target="_blank" rel="noopener noreferrer">YTKNetwork<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它将AFNetworking封装成抽象父类，然后根据每一种不同的网络请求，都编写不同的子类，子类继承父类，来实现请求业务。Moya在项目层次中的地位，有点类似于YTKNetwork。可以看下图对比</p> <p><img src="https://upload-images.jianshu.io/upload_images/661823-cd5c3ad3c5d3a54f.png" alt></p> <p>但是如果单纯把Moya等同于swift版的YTKNetwork，那就是比较错误的想法了。Moya的设计思路和YTKNetwork差距非常大。上面我在介绍YTKNetwork时在强调子类和父类，继承，是因为YTKNetwork是比较经典的利用OOP思想（面向对象）设计的产物。基于swift的Moya虽然也有使用到继承，但是它的整体上是以POP思想（Protocol Oriented Programming,面向协议编程）为主导的。</p> <h2 id="面向协议编程（pop）"><a href="#面向协议编程（pop）" aria-hidden="true" class="header-anchor">#</a> 面向协议编程（POP）</h2> <p>在阅读Moya源码之前，如果对POP有一定了解，那么理解其Moya会事半功倍的效果。在Objective-C也有协议，一般是让对象遵守协议，然后实现协议规定的方法，通过这种方式来对类实现扩展。POP其实就是把这种思路进一步强化。很多时候事物具备多样化的特质，而这些特质是无法单纯从一个类中继承而来的。为了解决这个痛点，C++有了多继承，即一个子类可以继承多种父类，这些被继承的父类之间不一定有关联。但是这依然会有其他问题，比如子类继承父类后，不一定需要用到所有的父类方法和属性，等于子类拥有了一些毫无用处的属性和方法。比如父类进行了修改，那么很难避免影响到子类。C++的多继承还会带来<code>菱形缺陷</code>，什么是<code>菱形缺陷</code>？本节的下方我会放两个链接，方便大家查阅。而Swift则引入了面向协议编程，通过协议来规定事物的实现。通过遵守不同的协议，来对一个类或者结构体或者枚举进行定制，它只需要实现协议所规定的属性或方法即可，有点类似于搭建积木，取每一块有需求的模块，进行组合拼接，相对于OOP，其耦合性更低，也为代码的维护和拓展提供更多的可能性。</p> <h2 id="moya的模块组成"><a href="#moya的模块组成" aria-hidden="true" class="header-anchor">#</a> Moya的模块组成</h2> <p>由于Moya是使用POP来设计的一个网络抽象层，因此他整体的逻辑结构并没有明显的继承关系。Moya的核心代码，可以分成以下几个模块:</p> <p><img src="https://upload-images.jianshu.io/upload_images/661823-83c87fc19acb676a.png" alt></p> <h2 id="provider"><a href="#provider" aria-hidden="true" class="header-anchor">#</a> Provider</h2> <p>provider是一个提供网络请求服务的提供者。通过一些初始化配置之后，在外部可以直接用provider来发起request。</p> <h2 id="request"><a href="#request" aria-hidden="true" class="header-anchor">#</a> Request</h2> <p>在使用Moya进行网络请求时，第一步需要进行配置，来生成一个Request。首先按照官方文档，创建一个枚举，遵守TargetType协议，并实现协议所规定的属性。为什么要创建枚举来遵守协议，而不像Objective-C那样创建类来遵守协议呢？其实使用类或者结构体也是可以的，这里猜测使用枚举的原因是因为swift的枚举功能比Objective-C强大许多，枚举结合switch语句，使得API管理起来比较方便。 Request的生成过程如下图</p> <p><img src="https://upload-images.jianshu.io/upload_images/661823-586eb8bfeee57869.png" alt></p> <p>我们根据上图，结合代码来分析其Request的生成过程。 根据创建了一个遵守TargetType协议的名为Myservice的枚举，我们完成了如下几个变量的设置。</p> <div class="language-swift extra-class"><pre class="language-swift"><code>baseURL
path
method
sampleData
task
headers
</code></pre></div><p>配置去生成所需要的请求。看上图的第一个箭头，通过了一个EndpointClosure生成了endPoint。endPoit是一个对象，把网络请求所需的一些属性和方法进行了包装，在EndPoint类中有如下属性：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token builtin">SampleResponseClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">EndpointSampleResponse</span>

open <span class="token keyword">let</span> url<span class="token punctuation">:</span> <span class="token builtin">String</span>
open <span class="token keyword">let</span> sampleResponseClosure<span class="token punctuation">:</span> <span class="token builtin">SampleResponseClosure</span>
open <span class="token keyword">let</span> method<span class="token punctuation">:</span> <span class="token builtin">Moya</span><span class="token punctuation">.</span><span class="token builtin">Method</span>
open <span class="token keyword">let</span> task<span class="token punctuation">:</span> <span class="token builtin">Task</span>
open <span class="token keyword">let</span> httpHeaderFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token operator">?</span>
</code></pre></div><p>可以很直观地看出来，EndPoint这几个属性可以和上面通过TargetTpye配置的变量对应起来。那么这个过程在代码中做了哪些事？ 在MoyaProvider类里，有如下声明</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Closure that defines the endpoints for the provider.</span>
<span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token builtin">EndpointClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">Target</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span>
open <span class="token keyword">let</span> endpointClosure<span class="token punctuation">:</span> <span class="token builtin">EndpointClosure</span>
</code></pre></div><p>声明了一个闭包，参数为Target，它是一个泛型，然后返回一个EndPoint。endPoint是一个类，它对请求的参数和动作进行了包装，下面会对它进行详细说明，先继续看endpointClosure做了什么。</p> <div class="language-swift extra-class"><pre class="language-swift"><code>endpointClosure<span class="token punctuation">:</span> @escaping <span class="token builtin">EndpointClosure</span> <span class="token operator">=</span> <span class="token builtin">MoyaProvider</span><span class="token punctuation">.</span>defaultEndpointMapping
</code></pre></div><p>在MoyaProvider的初始化方法里，调用其扩展的类方法<code>defaultEndpointMapping</code>输入Target作为参数，返回了一个endPoint对象。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">func</span> <span class="token function">defaultEndpointMapping</span><span class="token punctuation">(</span><span class="token keyword">for</span> target<span class="token punctuation">:</span> <span class="token builtin">Target</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
						<span class="token keyword">return</span> <span class="token function">Endpoint</span><span class="token punctuation">(</span>
            url<span class="token punctuation">:</span> <span class="token function">URL</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span>absoluteString<span class="token punctuation">,</span>
            sampleResponseClosure<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token function">networkResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>sampleData<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> target<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> target<span class="token punctuation">.</span>task<span class="token punctuation">,</span>
            httpHeaderFields<span class="token punctuation">:</span> target<span class="token punctuation">.</span>headers
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Target就是一开始进行配置的枚举，通过点语法取出Target的变量，完成endPoint的初始化。这里可能对于url和sampleResponseClosure会感到一些疑惑。url初始化，可以进入<code>URL+Moya.swift</code>查看，它对NSURL类进行构造器的扩展，让其具备根据Moya的TargetType来进行初始化的能力。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Initialize URL from Moya's `TargetType`.</span>
<span class="token keyword">init</span><span class="token operator">&lt;</span>T<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> T<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// When a TargetType's path is empty, URL.appendingPathComponent may introduce trailing /, which may not be wanted in some cases</span>
    <span class="token keyword">if</span> target<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token builtin">isEmpty</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>baseURL
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span> <span class="token operator">=</span> target<span class="token punctuation">.</span>baseURL<span class="token punctuation">.</span><span class="token function">appendingPathComponent</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>sampleResponseClosure是一个和网络请求返回假数据相关的闭包，这里可以先忽略，不影响对Moya生成Request过程的理解。 我们知道了MoyaProvider.defaultEndpointMapping可以返回endPoint对象后，重新看一遍这句</p> <div class="language-swift extra-class"><pre class="language-swift"><code>endpointClosure<span class="token punctuation">:</span> @escaping <span class="token builtin">EndpointClosure</span> <span class="token operator">=</span> <span class="token builtin">MoyaProvider</span><span class="token punctuation">.</span>defaultEndpointMapping
</code></pre></div><p>使用@escaping把endpointClosure声明为逃逸闭包，我们可以把</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token builtin">EndpointClosure</span> <span class="token operator">=</span> <span class="token builtin">MoyaProvider</span><span class="token punctuation">.</span>defaultEndpointMapping
</code></pre></div><p>转换为</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token punctuation">(</span><span class="token builtin">Target</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">func</span> <span class="token function">defaultEndpointMapping</span><span class="token punctuation">(</span><span class="token keyword">for</span> target<span class="token punctuation">:</span> <span class="token builtin">Target</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span>
</code></pre></div><p>再进一步转换，等号左边的可以写成一个常规的闭包表达式</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token builtin">Target</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span> <span class="token keyword">in</span>
	<span class="token keyword">return</span> <span class="token function">Endpoint</span><span class="token punctuation">(</span>
            url<span class="token punctuation">:</span> <span class="token function">URL</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> target<span class="token punctuation">)</span><span class="token punctuation">.</span>absoluteString<span class="token punctuation">,</span>
            sampleResponseClosure<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token function">networkResponse</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span>sampleData<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            method<span class="token punctuation">:</span> target<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
            task<span class="token punctuation">:</span> target<span class="token punctuation">.</span>task<span class="token punctuation">,</span>
            httpHeaderFields<span class="token punctuation">:</span> target<span class="token punctuation">.</span>headers
        <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>即endpointClosure这个闭包，传入了Target作为参数，该闭包可以返回一个endPoint对象,如何获取到闭包返回的endPoint对象？MoyaProvider提供了这么一个方法</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Returns an `Endpoint` based on the token, method, and parameters by invoking the `endpointClosure`.</span>
open <span class="token keyword">func</span> <span class="token function">endpoint</span><span class="token punctuation">(</span><span class="token number">_</span> token<span class="token punctuation">:</span> <span class="token builtin">Target</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">endpointClosure</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上就是关于TargetType通过endpointClosure转化为endPoint的过程。</p> <p>下一步就是把利用requestClosure，传入endPoint，然后生成request。request生成过程和endPoint很相似。</p> <p>在MoyaProvider中声明：</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Closure that decides if and what request should be performed</span>
<span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token builtin">RequestResultClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">Result</span><span class="token operator">&lt;</span><span class="token builtin">URLRequest</span><span class="token punctuation">,</span> <span class="token builtin">MoyaError</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span>
open <span class="token keyword">let</span> requestClosure<span class="token punctuation">:</span> <span class="token builtin">RequestClosure</span>
</code></pre></div><p>然后在MoyaProvider的初始化方法里有很相似的一句</p> <div class="language-swift extra-class"><pre class="language-swift"><code>requestClosure<span class="token punctuation">:</span> @escaping <span class="token builtin">RequestClosure</span> <span class="token operator">=</span> <span class="token builtin">MoyaProvider</span><span class="token punctuation">.</span>defaultRequestMapping
</code></pre></div><p>进入查看defaultRequestMapping方法</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">func</span> <span class="token function">defaultRequestMapping</span><span class="token punctuation">(</span><span class="token keyword">for</span> endpoint<span class="token punctuation">:</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> closure<span class="token punctuation">:</span> <span class="token builtin">RequestResultClosure</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> urlRequest <span class="token operator">=</span> <span class="token keyword">try</span> endpoint<span class="token punctuation">.</span><span class="token function">urlRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>urlRequest<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">requestMapping</span><span class="token punctuation">(</span><span class="token keyword">let</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">requestMapping</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">parameterEncoding</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">parameterEncoding</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
        <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">underlying</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token constant">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和endpointClosure类似，我们经过转换，可以得到requestClosure的表达式为</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token punctuation">{</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">:</span><span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> closure<span class="token punctuation">:</span><span class="token builtin">RequestResultClosure</span><span class="token punctuation">)</span> <span class="token keyword">in</span>
   <span class="token keyword">do</span> <span class="token punctuation">{</span>
       <span class="token keyword">let</span> urlRequest <span class="token operator">=</span> <span class="token keyword">try</span> endpoint<span class="token punctuation">.</span><span class="token function">urlRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
       <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>urlRequest<span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">requestMapping</span><span class="token punctuation">(</span><span class="token keyword">let</span> url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">requestMapping</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">parameterEncoding</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">parameterEncoding</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
       <span class="token function">closure</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token builtin">MoyaError</span><span class="token punctuation">.</span><span class="token function">underlying</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token constant">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整体上使用do-catch语句来初始化一个urlRequest，根据不同结果向闭包传入不同的参数。一开始使用try来调用endpoint.urlRequest()，如果抛出错误，会切换到catch语句中去。endpoint.urlRequest()这个方法比较长，这里就不放出来，感兴趣可自行到Moya核心代码里的Endpoint.swift里查看。它其实做的事情很简单，就是根据前面说到的endpoint的那些属性来初始化一个NSURLRequest的对象。</p> <p>以上就是上方图中所画的，根据TargetType最终生成Request的过程。很多人会感到疑惑，为什么搞得这么麻烦，直接一步到位，传一些必要参数生成Request不就完了？为什么还要再增加endPoint这么一个节点？根据Endpoint类所提供的一些方法来看，个人认为应该是为了更灵活地配置网络请求，以适应更多样化的业务需求。Endpoint类还有几个方法</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Convenience method for creating a new `Endpoint` with the same properties as the receiver, but with added HTTP header fields.</span>
open <span class="token keyword">func</span> <span class="token function">adding</span><span class="token punctuation">(</span>newHTTPHeaderFields<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">:</span> <span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span> 

<span class="token comment">/// Convenience method for creating a new `Endpoint` with the same properties as the receiver, but with replaced `task` parameter.</span>
open <span class="token keyword">func</span> <span class="token function">replacing</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">Task</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Endpoint</span><span class="token operator">&lt;</span><span class="token builtin">Target</span><span class="token operator">&gt;</span>
</code></pre></div><p>借用这些方法，在endpointClosure中可以给一些网络请求添加请求头，替换请求参数，让这些请求配置更加灵活。</p> <p>我们看完了整个Request生成过程，那么通过requestClosure生成的的Request是如何被外部拿到的呢？这就是我们下一步要探讨的，Provider发送请求实现过程。在下一节里将会看到如何使用这个Request。</p> <h2 id="provider发送请求"><a href="#provider发送请求" aria-hidden="true" class="header-anchor">#</a> Provider发送请求</h2> <p>我们再来看一下官方文档里说明的Moya的基本使用步骤</p> <ol><li>创建枚举，遵守TargetType协议，实现规定的属性。</li> <li>初始化 <code>provider = MoyaProvider&lt;Myservice&gt;()</code></li> <li>调用provider.request，在闭包里处理请求结果。</li></ol> <p>其中第一步我们在上方已经说明完了，MoyaProvider的初始化我们只说明了一小部分。在此不准备一口气初始化方法中剩余的部分讲完，这又会涉及很多东西，同时理解起来会比较麻烦。在后面的代码解读中，如果有涉及到相关属性，再回到初始化方法中一个一个突破。</p> <div class="language-swift extra-class"><pre class="language-swift"><code>open <span class="token keyword">func</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token number">_</span> target<span class="token punctuation">:</span> <span class="token builtin">Target</span><span class="token punctuation">,</span>
                  callbackQueue<span class="token punctuation">:</span> <span class="token builtin">DispatchQueue</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">none</span><span class="token punctuation">,</span>
                  progress<span class="token punctuation">:</span> <span class="token builtin">ProgressBlock</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token keyword">none</span><span class="token punctuation">,</span>
                  completion<span class="token punctuation">:</span> @escaping <span class="token builtin">Completion</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Cancellable</span> <span class="token punctuation">{</span>

    <span class="token keyword">let</span> callbackQueue <span class="token operator">=</span> callbackQueue <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">self</span><span class="token punctuation">.</span>callbackQueue
    <span class="token keyword">return</span> <span class="token function">requestNormal</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> callbackQueue<span class="token punctuation">:</span> callbackQueue<span class="token punctuation">,</span> progress<span class="token punctuation">:</span> progress<span class="token punctuation">,</span> completion<span class="token punctuation">:</span> completion<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>直接从这里可能看不出什么，再追溯到<code>requestNormal</code>中去 这个方法内容比较长，其中一些插件相关的代码，和测试桩的代码，暂且跳过不做说明，暂时不懂他们并不会成为理解provider.request的阻碍，它们属于可选内容，而不是必须的。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">let</span> endpoint <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">endpoint</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
</code></pre></div><p>生成了endPoint对象，这个很好理解，前面已经做过说明。 查看<code>performNetworking</code>闭包</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">if</span> cancellableToken<span class="token punctuation">.</span>isCancelled <span class="token punctuation">{</span>
          <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">cancelCompletion</span><span class="token punctuation">(</span>pluginsWithCompletion<span class="token punctuation">,</span> target<span class="token punctuation">:</span> target<span class="token punctuation">)</span>
          <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
</code></pre></div><p>如果取消请求，则调用取消完成的回调，并return,不在执行闭包内下面的语句。 在这个闭包里传入了参数<code>(requestResult: Result&lt;URLRequest, MoyaError&gt;)</code>，这里用到了<a href="https://link.juejin.im?target=https%3A%2F%2Fgithub.com%2Fantitypical%2FResult" target="_blank" rel="noopener noreferrer">Result<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,想深入了解，可自行研究，这里简单说一下Result是干什么的。Result使用枚举方式，提供一些运行处理的结果,如下，很容易能看懂它所表达的意思。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">switch</span> requestResult <span class="token punctuation">{</span>
<span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token keyword">let</span> urlRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
	request <span class="token operator">=</span> urlRequest
<span class="token keyword">case</span> <span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span><span class="token keyword">let</span> error<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token function">pluginsWithCompletion</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token function">failure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果请求成功，会拿到URLRequest，如果失败，会使用插件去处理失败回调。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">// Allow plugins to modify request</span>
<span class="token keyword">let</span> preparedRequest <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span> <span class="token punctuation">{</span> $<span class="token number">1</span><span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>$<span class="token number">0</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> target<span class="token punctuation">)</span> <span class="token punctuation">}</span>
</code></pre></div><p>使用插件对请求进行完善</p> <div class="language-swift extra-class"><pre class="language-swift"><code>cancellableToken<span class="token punctuation">.</span>innerCancellable <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">performRequest</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> request<span class="token punctuation">:</span> preparedRequest<span class="token punctuation">,</span> callbackQueue<span class="token punctuation">:</span> callbackQueue<span class="token punctuation">,</span> progress<span class="token punctuation">:</span> progress<span class="token punctuation">,</span> completion<span class="token punctuation">:</span> networkCompletion<span class="token punctuation">,</span> endpoint<span class="token punctuation">:</span> endpoint<span class="token punctuation">,</span> stubBehavior<span class="token punctuation">:</span> stubBehavior<span class="token punctuation">)</span>
</code></pre></div><p>这里的<code>self.performRequest</code>就是进行实际的网络请求，内部代码比较多，但是思路很简单，使用Alamofire的SessionManager来发送请求。 配置完成后就可以调用<code>requestClosure(endpoint, performNetworking)</code>，执行这个闭包获取到上方所说的Request，来执行具体的网络请求了。</p> <h2 id="response"><a href="#response" aria-hidden="true" class="header-anchor">#</a> Response</h2> <p>在使用Alamofire发送请求时，定义了闭包来处理请求的响应。Response这个类对于请求结果，提供了一些加工方法，比如data转json,图片转换等。</p> <h2 id="plugins"><a href="#plugins" aria-hidden="true" class="header-anchor">#</a> Plugins</h2> <p>Moya提供了一个插件协议<code>PluginType</code>，协议里规定了几种方法，阐明了插件的应用区域。</p> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token comment">/// Called to modify a request before sending</span>
<span class="token keyword">func</span> <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token number">_</span> request<span class="token punctuation">:</span> <span class="token builtin">URLRequest</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">URLRequest</span>

<span class="token comment">/// Called immediately before a request is sent over the network (or stubbed).</span>
<span class="token keyword">func</span> <span class="token function">willSend</span><span class="token punctuation">(</span><span class="token number">_</span> request<span class="token punctuation">:</span> <span class="token builtin">RequestType</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span>

<span class="token comment">/// Called after a response has been received, but before the MoyaProvider has invoked its completion handler.</span>
<span class="token keyword">func</span> <span class="token function">didReceive</span><span class="token punctuation">(</span><span class="token number">_</span> result<span class="token punctuation">:</span> <span class="token builtin">Result</span><span class="token operator">&lt;</span><span class="token builtin">Moya</span><span class="token punctuation">.</span><span class="token builtin">Response</span><span class="token punctuation">,</span> <span class="token builtin">MoyaError</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span>

<span class="token comment">/// Called to modify a result before completion</span>
<span class="token keyword">func</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token number">_</span> result<span class="token punctuation">:</span> <span class="token builtin">Result</span><span class="token operator">&lt;</span><span class="token builtin">Moya</span><span class="token punctuation">.</span><span class="token builtin">Response</span><span class="token punctuation">,</span> <span class="token builtin">MoyaError</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Result</span><span class="token operator">&lt;</span><span class="token builtin">Moya</span><span class="token punctuation">.</span><span class="token builtin">Response</span><span class="token punctuation">,</span> <span class="token builtin">MoyaError</span><span class="token operator">&gt;</span>
</code></pre></div><ul><li><code>prepare</code>可以在请求之前对request进行修改。</li> <li><code>willSend</code>在请求发送之前的一瞬间调用，这个可以用来添加请求时转圈圈的Toast</li> <li><code>didReceive</code>在接收到请求响应时，且MoyaProvider的completion handler之前调用。</li> <li><code>process</code>在completion handler之前调用，用来修改请求结果 可以通过以下图来直观地理解插件调用时机</li></ul> <p><img src="https://upload-images.jianshu.io/upload_images/661823-6533abce8da63531.png" alt></p> <ul><li>使用插件的方式，让代码仅保持着主干逻辑，使用者根据业务需求自行加入插件来配置自己的网络业务层，这样做更加灵活，低耦合。Moya提供了4种插件</li> <li>AccessTokenPlugin OAuth的Token验证</li> <li>CredentialsPlugin 证书</li> <li>NetworkActivityPlugin 网络请求状态</li> <li>NetworkLoggerPlugin 网络日志 可以根据需求编写自己的插件，选取NetworkActivityPlugin来查看插件内部构成。</li></ul> <div class="language-swift extra-class"><pre class="language-swift"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NetworkActivityPlugin</span><span class="token punctuation">:</span> <span class="token builtin">PluginType</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">typealias</span> <span class="token builtin">NetworkActivityClosure</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">_</span> change<span class="token punctuation">:</span> <span class="token builtin">NetworkActivityChangeType</span><span class="token punctuation">,</span> <span class="token number">_</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">Void</span>
    <span class="token keyword">let</span> networkActivityClosure<span class="token punctuation">:</span> <span class="token builtin">NetworkActivityClosure</span>

    <span class="token keyword">public</span> <span class="token keyword">init</span><span class="token punctuation">(</span>networkActivityClosure<span class="token punctuation">:</span> @escaping <span class="token builtin">NetworkActivityClosure</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>networkActivityClosure <span class="token operator">=</span> networkActivityClosure
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">willSend</span><span class="token punctuation">(</span><span class="token number">_</span> request<span class="token punctuation">:</span> <span class="token builtin">RequestType</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">networkActivityClosure</span><span class="token punctuation">(</span><span class="token punctuation">.</span>began<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function">didReceive</span><span class="token punctuation">(</span><span class="token number">_</span> result<span class="token punctuation">:</span> <span class="token builtin">Result</span><span class="token operator">&lt;</span><span class="token builtin">Moya</span><span class="token punctuation">.</span><span class="token builtin">Response</span><span class="token punctuation">,</span> <span class="token builtin">MoyaError</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">TargetType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">networkActivityClosure</span><span class="token punctuation">(</span><span class="token punctuation">.</span>ended<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>插件内部结构很简单，除了自行定义的一些变量外，就是遵守<code>PluginType</code>协议后，去实现协议规定的方法，在特定方法内做自己需要做的事。因为<code>PluginType</code>它已经有一个协议扩展，把方法的默认实现都完成了，在具体插件内不一定需要实现所有的协议方法，仅根据需要实现特定方法即可。 写好插件之后，使用起来也比较简答，MoyaProvider的初始化方法中，有个形参<code>plugins: [PluginType] = []</code>，把网络请求中需要用到的插件加入数组中。</p> <h2 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h2> <p>Moya可以说是非常Swift式的一个框架，最大的优点是使用面向协议的思想，让使用者能以搭积木的方式配置自己的网络抽象层。提供了插件机制，在保持主干网络请求逻辑的前提下，让开发者根据自身业务需求，定制自己的插件，在合适的位置加入到网络请求的过程中。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/source/swift/Swift-Protocol.html" class="prev">
          Swift 协议 protocol
        </a></span> <span class="next"><a href="/source/swift/Swift-Error.html">
          Swift Error 的分类
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.1622ce37.js" defer></script><script src="/assets/js/84.9867ac89.js" defer></script>
  </body>
</html>
